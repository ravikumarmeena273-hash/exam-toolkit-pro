<!DOCTYPE html>
<html lang="hi">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Ultimate Scientific & Chemical Exam Engine (V4.0)</title>

<script>
  window.MathJax = {
    tex: { inlineMath: [['$', '$'], ['\\(', '\\)']] },
    svg: { fontCache: 'global' }
  };
</script>
<script id="MathJax-script" async src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js"></script>

<script src="https://unpkg.com/smiles-drawer@2.0.1/dist/smiles-drawer.min.js"></script>

<style>
@import url('https://fonts.googleapis.com/css2?family=Noto+Serif+Devanagari:wght@400;700&family=Roboto:wght@400;500;700&display=swap');

@page { size: A4 portrait; margin: 0.5in; }
body { font-family: "Roboto", "Noto Serif Devanagari", sans-serif; background: #f0f2f5; margin: 0; color: #333; }

/* Control Panel */
.no-print { background: #fff; padding: 20px; box-shadow: 0 4px 12px rgba(0,0,0,0.1); border-bottom: 1px solid #ddd; }
textarea { width: 100%; height: 180px; font-family: monospace; font-size: 13px; padding: 10px; border: 1px solid #ccc; border-radius: 6px; margin-bottom: 10px; }

.btn-bar { display: flex; gap: 10px; flex-wrap: wrap; }
button { padding: 10px 20px; cursor: pointer; border: none; border-radius: 6px; font-weight: 600; color: white; transition: 0.2s; }
.btn-blue { background: #007bff; } .btn-blue:hover { background: #0056b3; }
.btn-green { background: #28a745; } .btn-green:hover { background: #218838; }
.btn-fix { background: #ffc107; color: #000; } .btn-fix:hover { background: #e0a800; }

/* Paper Layout */
.paper-container { background: white; width: 210mm; min-height: 297mm; margin: 20px auto; padding: 15mm; box-shadow: 0 0 20px rgba(0,0,0,0.05); }

.header { display: flex; justify-content: space-between; border-bottom: 2px solid #000; margin-bottom: 20px; padding-bottom: 10px; font-weight: bold; font-size: 18px; text-transform: uppercase; }

.paper-content { column-count: 2; column-gap: 30px; column-rule: 1px solid #eee; text-align: justify; }

/* Questions */
.block { break-inside: avoid; margin-bottom: 20px; padding-bottom: 15px; border-bottom: 1px dashed #e0e0e0; }
.q-row { display: flex; gap: 8px; align-items: baseline; }
.q-no { font-weight: 900; color: #d63384; min-width: 35px; }
.q-text { font-weight: 500; }

.options { margin: 8px 0 0 40px; font-size: 14px; }
.opt { margin-bottom: 6px; display: block; }

/* Canvas for Structures */
canvas.chem-struct { vertical-align: middle; border: 1px solid #f0f0f0; border-radius: 4px; background: #fff; margin: 5px; display: block; }
.img-placeholder { display: inline-block; background: #ffeeba; border: 1px dashed #d39e00; padding: 10px; color: #856404; font-size: 12px; border-radius: 4px; margin: 5px 0; width: 90%; text-align: center; }

/* Answers */
.ans-box { background: #f1f8ff; border-left: 4px solid #007bff; padding: 10px; margin-top: 10px; border-radius: 0 4px 4px 0; font-size: 13px; display: none; }
.label { font-weight: bold; color: #0056b3; }

/* Answer Key Page */
.key-page { column-span: all; break-before: page; margin-top: 30px; }
.key-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(300px, 1fr)); gap: 15px; }
.key-item { background: #fff; border: 1px solid #ddd; padding: 10px; border-radius: 4px; font-size: 12px; }

@media print {
  body { background: white; }
  .no-print { display: none; }
  .paper-container { width: 100%; box-shadow: none; margin: 0; padding: 0; }
  .paper-content { column-count: 2; }
}
</style>
</head>
<body>

<div class="no-print">
  <h2 style="margin:0 0 10px 0;">üß™ Ultimate Exam Engine (Text + Math + Chemistry)</h2>
  <textarea id="inputText" placeholder="Paste Gemini Output here (with [SMILES: ...] codes)..."></textarea>
  
  <div class="btn-bar">
    <button class="btn-fix" onclick="autoFix()">üõ†Ô∏è Auto-Fix Formatting</button>
    <button class="btn-blue" onclick="render(1)">Mode 1: Show Answers</button>
    <button class="btn-blue" onclick="render(2)">Mode 2: Answer Key at End</button>
    <button class="btn-blue" onclick="render(0)">Mode 3: Question Paper</button>
    <button class="btn-green" onclick="window.print()">üñ®Ô∏è Print PDF</button>
  </div>
</div>

<div class="paper-container">
  <div class="header">
    <div>Advanced Scientific Mock Test</div>
    <div>Time: 2:30 Hrs | Marks: 300</div>
  </div>
  <div class="paper-content" id="paper"></div>
</div>

<script>
// üîπ 1. Text Fixer Logic (Preserved)
function autoFix() {
    let text = document.getElementById("inputText").value;
    text = text.replace(/‚îÅ+/g, '');
    text = text.replace(/(?<!\n)###Q/g, '\n###Q');
    text = text.replace(/(?<!\n)##([A-E])/g, '\n##$1');
    text = text.replace(/###ANS\s*:\s*/g, '\n###ANS: ');
    document.getElementById("inputText").value = text;
    alert("Formatting Fixed! Now click a Render Mode.");
}

// üîπ 2. Rendering Logic (Upgraded)
function render(mode) {
    const raw = document.getElementById("inputText").value;
    const paper = document.getElementById("paper");
    paper.innerHTML = "";
    
    const blocks = raw.split(/###Q/).slice(1);
    let keyHTML = "";

    blocks.forEach((block, index) => {
        let qNum = block.match(/^\s*(\d+)/)?.[1] || (index + 1);
        let cleanBlock = block.replace(/^\s*\d+/, '').trim();

        let parts = cleanBlock.split('###ANS');
        let qContent = parts[0];
        let ansContent = parts[1] ? '###ANS' + parts[1] : "";

        // Function to process content (SMILES + Images + Line Breaks)
        const format = (str) => {
            if(!str) return "";
            
            // Convert [SMILES: ...] to Canvas
            str = str.replace(/\[SMILES:\s*([^\]]+)\]/g, (match, smile) => {
                let id = 'canvas_' + Math.random().toString(36).substr(2, 9);
                // Queue the drawing
                setTimeout(() => drawSmiles(id, smile), 100);
                return `<canvas id="${id}" class="chem-struct" width="150" height="100"></canvas>`;
            });

            // Convert [IMAGE_REQUIRED] to Placeholder
            str = str.replace(/\[IMAGE_REQUIRED\]/g, 
                `<div class="img-placeholder">üì∏ [Diagram/Graph Required]<br>Paste Screenshot After Printing</div>`);

            return str.replace(/\n/g, "<br>");
        };

        // Extract Options
        const getOpt = (tag) => {
            let m = qContent.match(new RegExp(`##${tag}([^#]*)`, 'i'));
            return m ? m[1].split(/##[A-E]/)[0].trim() : null;
        };

        let optA = getOpt('A');
        let optB = getOpt('B');
        let optC = getOpt('C');
        let optD = getOpt('D');
        let optE = getOpt('E');

        let qText = qContent.split(/##[A-E]/)[0].trim();

        // Answer Parsing
        let ansVal = "", expVal = "";
        if (ansContent) {
            let ap = ansContent.split('###EXP');
            ansVal = ap[0].replace('###ANS', '').replace(/^[:\s\(\)]+/g, '').replace(/[\(\)]/g, '').trim();
            expVal = ap[1] ? ap[1].trim() : "";
        }

        // Create HTML Block
        let div = document.createElement("div");
        div.className = "block";
        
        let html = `
            <div class="q-row">
                <div class="q-no">Q.${qNum}</div>
                <div class="q-text">${format(qText)}</div>
            </div>
            <div class="options">
                ${optA ? `<span class="opt"><b>(A)</b> ${format(optA)}</span>` : ''}
                ${optB ? `<span class="opt"><b>(B)</b> ${format(optB)}</span>` : ''}
                ${optC ? `<span class="opt"><b>(C)</b> ${format(optC)}</span>` : ''}
                ${optD ? `<span class="opt"><b>(D)</b> ${format(optD)}</span>` : ''}
                ${optE ? `<span class="opt"><b>(E)</b> ${format(optE)}</span>` : ''}
            </div>
        `;

        if (mode === 1) {
            html += `
                <div class="ans-box" style="display:block">
                    <div><span class="label">‡§â‡§§‡•ç‡§§‡§∞:</span> (${ansVal})</div>
                    <div style="margin-top:5px"><span class="label">‡§µ‡•ç‡§Ø‡§æ‡§ñ‡•ç‡§Ø‡§æ:</span> ${format(expVal)}</div>
                </div>
            `;
        }
        
        div.innerHTML = html;
        paper.appendChild(div);

        // Add to Key
        if (mode === 2) {
            keyHTML += `
                <div class="key-item">
                    <b>Q.${qNum}</b>: (${ansVal})<br>
                    <span style="color:#555; font-size:11px">${format(expVal)}</span>
                </div>
            `;
        }
    });

    if (mode === 2) {
        let keyDiv = document.createElement("div");
        keyDiv.className = "key-page";
        keyDiv.innerHTML = `<h3>Answer Key & Explanations</h3><div class="key-grid">${keyHTML}</div>`;
        paper.appendChild(keyDiv);
    }

    // Render Math
    if (window.MathJax) {
        MathJax.typesetPromise([paper]).catch(err => console.log(err));
    }
}

// üîπ 3. Chemical Drawing Function
function drawSmiles(canvasId, smileString) {
    let options = { 
        width: 150, 
        height: 100,
        bondThickness: 1.2,
        padding: 5.0,
        textColor: '#000000'
    };
    
    let smilesDrawer = new SmilesDrawer.Drawer(options);
    SmilesDrawer.parse(smileString, function(tree) {
        smilesDrawer.draw(tree, canvasId, 'light', false);
    }, function(err) {
        console.log("Smiles Error:", err);
    });
}
</script>

</body>
</html>